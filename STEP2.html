<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-YW913537F4"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-YW913537F4');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1600">
    <title>PMV 3 - Performance</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="step1-styles.css">
    <style>
        .calc-buttons-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
        .calc-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.25rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            white-space: nowrap;
            box-shadow: var(--shadow-sm);
        }
        .calc-btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .calc-btn.active { background: linear-gradient(135deg, #2563eb 0%, #60a5fa 100%); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }
        .result-item {
            background: var(--bg-main);
            border-radius: var(--radius-sm);
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--border);
        }
        .result-item label {
            display: block;
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 0.2rem;
        }
        .result-item input {
            width: 100%;
            background: transparent;
            border: none;
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--primary);
            outline: none;
        }
        
        .chart-scroll-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }
        .chart-scroll-container canvas { display: none; border: none; }
        .chart-scroll-container canvas.active { display: block; }
        
        .chart-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: var(--text-muted);
            gap: 0.75rem;
        }
        .chart-placeholder svg { width: 48px; height: 48px; opacity: 0.4; }
        .chart-placeholder p { font-size: 0.875rem; font-weight: 500; }
        
        .chart-title-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .performance-top-row {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 1rem;
        }
        
        #card-calculations .card-body,
        #card-results .card-body {
            padding: 0.75rem 1rem;
        }
        
        .chart-card-full { grid-column: 1 / -1; }
        
        /* Hide the default toast overlay */
        .toast-overlay, .toast {
            display: none !important;
        }
        
        .chart-error-message {
            display: none;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
            border: 1px solid var(--danger);
            border-radius: var(--radius-md);
            color: var(--danger);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.75rem;
            text-align: center;
        }
        
        .chart-error-message.show {
            display: block;
        }
        
        .chart-error-message svg {
            width: 18px;
            height: 18px;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container" style="border: 1px solid black; border-radius: 10px; padding: 10px; box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.785); max-width: 1600px; margin: 0 auto;">
    
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="brand">
                <img src="SAUDI_CARACAL_TRANSPARENT.png" alt="Cougar Helicopter" class="brand-logo" style="height: 60px; width: auto;">
                <div class="brand-text">
                    <h1>PMV 3</h1>
                    <span>COUGAR<br>AS 532 A2</span>
                </div>
            </div>
            <nav class="nav-tabs">
                <button class="nav-tab step" onclick="setActiveStep(this, 'STEP1')">STEP 1: Weight & Balance</button>
                <span class="nav-arrow"></span>
                <button class="nav-tab step active" onclick="setActiveStep(this, 'STEP2')">STEP 2: Performance</button>
                <span class="nav-arrow"></span>
                <button class="nav-tab step" onclick="setActiveStep(this, 'STEP3')">STEP 3: Endurance</button>
                <button class="nav-tab step" onclick="setActiveStep(this, 'FCF')">FCF</button>
            </nav>
            <img src="sqn-trans.png" alt="Squadron Logo" style="height: 80px; width: auto; filter: brightness(0) invert(1);">
        </div>
    </header>

    <!-- Main Container -->
    <div class="app-container">
        <div class="main-content">
            
            <!-- Cards Grid -->
            <div class="cards-grid">
                
                <!-- Top Row: Calculations + Results side by side -->
                <div class="performance-top-row" style="grid-column: 1 / -1;">
                    
                    <!-- Calculations Card -->
                    <div class="card" id="card-calculations">
                        <div class="card-header" onclick="toggleCard('card-calculations')">
                            <h3>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/></svg>
                                Performance Calculations
                            </h3>
                            <span class="card-toggle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                        </div>
                        <div class="card-body">
                            <div class="calc-buttons-grid">
                                <button class="calc-btn" id="btn-heightloss" onclick="runCalc('heightloss')">Height Loss</button>
                                <button class="calc-btn" id="btn-weightindex" onclick="runCalc('weightindex')">Weight Index</button>
                                <button class="calc-btn" id="btn-serviceceiling" onclick="runCalc('serviceceiling')">Service Ceiling</button>
                                <button class="calc-btn" id="btn-twinoge" onclick="runCalc('twinoge')">Twin OGE</button>
                                <button class="calc-btn" id="btn-twinige" onclick="runCalc('twinige')">Twin IGE 10ft</button>
                                <button class="calc-btn" id="btn-twinige5ft" onclick="runCalc('twinige5ft')">Twin IGE 5ft</button>
                                <button class="calc-btn" id="btn-oeiclimb" onclick="runCalc('oeiclimb')">OEI Climb</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Card -->
                    <div class="card" id="card-results">
                        <div class="card-header" onclick="toggleCard('card-results')">
                            <h3>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                Calculation Results
                            </h3>
                            <span class="card-toggle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                        </div>
                        <div class="card-body">
                            <div class="results-grid">
                                <div class="result-item">
                                    <label>Height Loss (ft)</label>
                                    <input type="text" id="#heightloose" readonly placeholder="--">
                                </div>
                                <div class="result-item">
                                    <label>Weight Index</label>
                                    <input type="text" id="#Wheight_index_6" readonly placeholder="--">
                                </div>
                                <div class="result-item">
                                    <label>Service Ceiling (ft)</label>
                                    <input type="text" id="#ceilinghp_3" readonly placeholder="--">
                                </div>
                                <div class="result-item">
                                    <label>OEI V/S (ft/min)</label>
                                    <input type="text" id="#rc" readonly placeholder="--">
                                </div>
                                <div class="result-item">
                                    <label>Twin OGE (ft)</label>
                                    <input type="text" id="#enginhoge" readonly placeholder="--">
                                </div>
                                <div class="result-item">
                                    <label>Twin OGE (lb)</label>
                                    <input type="text" id="#enginhoge_weight" readonly placeholder="--">
                                </div>
                                <div class="result-item">
                                    <label>Twin IGE 10ft (ft)</label>
                                    <input type="text" id="#enginIGE" readonly placeholder="--">
                                </div>
                                <div class="result-item">
                                    <label>Twin IGE 10ft (lb)</label>
                                    <input type="text" id="#enginIGE_weight" readonly placeholder="--">
                                </div>
                                <div class="result-item">
                                    <label>Twin IGE 5ft (ft)</label>
                                    <input type="text" id="#enginIGE5ft" readonly placeholder="--">
                                </div>
                                <div class="result-item">
                                    <label>Twin IGE 5ft (lb)</label>
                                    <input type="text" id="#enginIGE5ft_weight" readonly placeholder="--">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>

                <!-- Quick Info Bar -->
                <div class="quick-info-bar" style="grid-column: 1 / -1;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; color: white; font-weight: 600;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
                        Performance Data
                    </div>
                    <div class="form-field">
                        <label for="#acweight">Total Weight (lb)</label>
                        <input type="text" id="#acweight" name="acweight" placeholder="From STEP1" readonly>
                    </div>
                    <div class="form-field">
                        <label for="#qat">OAT (C)</label>
                        <input type="number" id="#qat" name="qat" placeholder="15">
                    </div>
                    <div class="form-field">
                        <label for="#hp">Altitude (ft)</label>
                        <input type="number" id="#hp" name="hp" placeholder="0">
                    </div>
                    <div class="form-field">
                        <label for="#wind">Wind (kt)</label>
                        <input type="number" id="#wind" name="wind" placeholder="0">
                    </div>
                </div>

                <!-- Chart Display Card (Full Width) -->
                <div class="card chart-card-full" id="card-chart">
                    <div class="card-header" onclick="toggleCard('card-chart')">
                        <h3>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                            Performance Chart
                        </h3>
                        <span class="chart-title-badge" id="chart-title">Select a calculation to view chart</span>
                        <span class="card-toggle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m6 9 6 6 6-6"/></svg></span>
                    </div>
                    <div class="card-body" style="padding: 0.75rem;">
                        <div class="chart-error-message" id="chart-error">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                            <span id="chart-error-text">Error message here</span>
                        </div>
                        <div class="chart-scroll-container" id="chart-display">
                            <div class="chart-placeholder" id="chart-placeholder">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/>
                                </svg>
                                <p>Click a calculation button to display the chart</p>
                            </div>
                            <canvas id="curveCanvas" width="950" height="1300" style="background-image: url('first.jpg'); "></canvas>
                            <canvas id="curveCanvas1" width="960" height="1300" style="background-image: url('WeightIndexForRateofclime.jpg'); "></canvas>
                            <canvas id="curveCanvas2" width="560" height="820" style="background-image: url('third.jpg'); "></canvas>
                            <canvas id="curveCanvas3" width="733" height="817" style="background-image: url('newOGE.jpg'); "></canvas>
                            <canvas id="curveCanvas4" width="733" height="814" style="background-image: url('newIGE.jpg'); "></canvas>
                            <canvas id="curveCanvas5" width="920" height="1280" style="background-image: url('sixth.jpg'); "></canvas>
                            <canvas id="curveCanvas6" width="595" height="822" style="background-image: url('5ft_ige/5ft_ige.png');"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    </div>

    <!-- Hidden inputs needed by scripts -->
    <div style="display: none;">
        <input type="text" id="#weighindex">
        <input type="text" id="#ceilinghp_2">
        <input type="text" id="#ceilingweight_3">
        <input type="hidden" id="zfw">
        <div id="#for0"></div>
        <div id="#for1"></div>
        <div id="#for2"></div>
        <div id="#for3"></div>
        <div id="#for4"></div>
        <div id="#for5"></div>
    </div>
    
    <div class="toast-overlay" id="toast-overlay"></div>
    
    <!-- Scripts -->
    <script src="dataPersistence.js"></script>
    <script src="navigation.js"></script>
    <script src="./datafolder/heightloosemap.js"></script>
    <script src="./datafolder/weightindex.js"></script>
    <script src="./datafolder/serviceCeiling.js"></script>
    <script src="./datafolder/newhoge.js"></script>
    <script src="./datafolder/newIGE.js"></script>
    <script src="./5ft_ige/5ft_ige.js"></script>
    <script src="./5ft_ige/5ft_calculator.js"></script>
    <script src="./datafolder/serviceclimbing.js"></script>
    <script src="./scripts.js"></script>
    <script src="step2DataHandler.js"></script>
    
    <script>
        const chartTitles = {
            'heightloss': 'Height Loss Chart',
            'weightindex': 'Weight Index Chart',
            'serviceceiling': 'Service Ceiling Chart',
            'twinoge': 'Twin Engine OGE Hover',
            'twinige': 'Twin Engine IGE 10ft Hover',
            'twinige5ft': 'Twin Engine IGE 5ft Hover',
            'oeiclimb': 'OEI Rate of Climb Chart'
        };
        
        let activeCalc = null;
        
        function runCalc(type) {
            // Update chart title
            document.getElementById('chart-title').textContent = chartTitles[type] || 'Chart';
            
            // Hide placeholder
            const placeholder = document.getElementById('chart-placeholder');
            if (placeholder) placeholder.style.display = 'none';
            
            // Hide curveCanvas6 (5ft IGE) - it's not managed by the original showchart function
            const canvas6 = document.getElementById('curveCanvas6');
            if (canvas6) canvas6.style.display = 'none';
            
            // Update active button state
            document.querySelectorAll('.calc-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.getElementById('btn-' + type);
            if (activeBtn) activeBtn.classList.add('active');
            
            activeCalc = type;
            
            // Call original functions - they handle everything including canvas display
            switch(type) {
                case 'heightloss': heightloosebuttondown(); break;
                case 'weightindex': weightindexbuttondown(); break;
                case 'serviceceiling': serviceilingbuttondown(); break;
                case 'twinoge': enginhogebuttondown(); break;
                case 'twinige': enginigebuttondown(); break;
                case 'twinige5ft': enginige5ftbuttondown(); break;
                case 'oeiclimb': rcbuttondown(); break;
            }
        }
        
        function toggleCard(cardId) {
            const card = document.getElementById(cardId);
            if (card) card.classList.toggle('collapsed');
        }
        
        function setActiveStep(element, stepId) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            element.classList.add('active');
            
            switch(stepId) {
                case 'STEP1': saveDataAndGoToStep1(); break;
                case 'STEP2': saveDataAndGoToStep2(); break;
                case 'STEP3': saveDataAndGoToStep3(); break;
                case 'FCF': saveDataAndNavigate('FCF.html'); break;
            }
        }
        
        // Let original showchart work, just hide placeholder when canvas shows
        const originalShowchartCheck = setInterval(function() {
            const visibleCanvas = document.querySelector('.chart-scroll-container canvas[style*="display: block"], .chart-scroll-container canvas[style*="display:block"]');
            if (visibleCanvas) {
                const placeholder = document.getElementById('chart-placeholder');
                if (placeholder) placeholder.style.display = 'none';
            }
        }, 100);
        
        // Override showToast to display in chart area instead
        window.showToast = function(message, type) {
            showChartError(message);
        };
        
        // Function to show error in chart area
        function showChartError(message) {
            const errorDiv = document.getElementById('chart-error');
            const errorText = document.getElementById('chart-error-text');
            if (errorDiv && errorText) {
                errorText.textContent = message;
                errorDiv.classList.add('show');
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    errorDiv.classList.remove('show');
                }, 5000);
            }
        }
        
        // Function to hide error
        function hideChartError() {
            const errorDiv = document.getElementById('chart-error');
            if (errorDiv) {
                errorDiv.classList.remove('show');
            }
        }
        
        // Override console.log to catch error messages
        const originalConsoleLog = console.log;
        console.log = function(...args) {
            const message = args.join(' ');
            if (message.includes('Unable to calculate') || message.includes('Error')) {
                showChartError(message);
            }
            originalConsoleLog.apply(console, args);
        };
        
        // Override alert to catch error messages
        const originalAlert = window.alert;
        window.alert = function(message) {
            if (message && (message.includes('Unable to calculate') || message.includes('Error') || message.includes('error'))) {
                showChartError(message);
            } else {
                originalAlert(message);
            }
        };

        // 5ft IGE calculation function
        function enginige5ftbuttondown() {
            // Show canvas 6 (5ft IGE)
            document.querySelectorAll('.chart-scroll-container canvas').forEach(c => {
                c.style.display = 'none';
            });
            document.getElementById('curveCanvas6').style.display = 'block';
            document.getElementById('chart-placeholder').style.display = 'none';
            
            // Get canvas and context
            const canvas6 = document.getElementById('curveCanvas6');
            const ctx6 = canvas6.getContext('2d');
            ctx6.clearRect(0, 0, canvas6.width, canvas6.height);
            
            // Get input values
            const qat = parseFloat(document.getElementById('#qat').value);
            const hp = parseFloat(document.getElementById('#hp').value);
            const acweight = parseFloat(document.getElementById('#acweight').value);
            
            // Validate inputs
            if (isNaN(qat) || isNaN(hp) || isNaN(acweight)) {
                document.getElementById('#enginIGE5ft').value = 'Invalid input';
                document.getElementById('#enginIGE5ft_weight').value = 'Invalid input';
                return;
            }
            
            if (qat < -50 || qat > 50) {
                document.getElementById('#enginIGE5ft').value = 'OAT out of range';
                document.getElementById('#enginIGE5ft_weight').value = 'OAT out of range';
                return;
            }
            
            // Calculate max altitude for given weight and temperature
            const maxAlt = findHeight5ft(qat, acweight);
            console.log('5ft IGE - Input: OAT=' + qat + ', Alt=' + hp + ', Weight=' + acweight);
            console.log('5ft IGE - Max Altitude for weight ' + acweight + ': ' + maxAlt);
            console.log('5ft IGE - chartData available: ' + (typeof chartData !== 'undefined'));
            if (maxAlt !== null && !isNaN(maxAlt)) {
                document.getElementById('#enginIGE5ft').value = maxAlt.toFixed(2);
            } else {
                document.getElementById('#enginIGE5ft').value = 'Unable to calculate';
            }
            
            // Calculate max weight for given altitude and temperature using findWeight from 5ft_calculator.js
            if (typeof findWeight === 'function') {
                const maxWeight = findWeight(qat, hp);
                console.log('5ft IGE - Max Weight for altitude ' + hp + ': ' + maxWeight);
                if (maxWeight !== null && !isNaN(maxWeight)) {
                    document.getElementById('#enginIGE5ft_weight').value = maxWeight.toFixed(2);
                } else {
                    document.getElementById('#enginIGE5ft_weight').value = 'Unable to calculate';
                }
                
                // Draw on canvas
                draw5ftIGEChart(ctx6, canvas6, qat, hp, acweight, maxWeight, maxAlt);
            } else {
                document.getElementById('#enginIGE5ft_weight').value = 'Calculator not loaded';
            }
        }
        
        // Helper function to find altitude for given temperature and weight
        function findHeight5ft(temperature, weight) {
            if (typeof chartData === 'undefined') return null;
            
            // Find all curves that contain this weight and get their heights
            let validPoints = [];
            
            for (let i = 0; i < chartData.length; i++) {
                const height = findHeightForWeight(chartData[i], weight);
                if (height !== null) {
                    validPoints.push({
                        temperature: chartData[i].temperature,
                        height: height
                    });
                }
            }
            
            if (validPoints.length === 0) return null;
            if (validPoints.length === 1) return validPoints[0].height;
            
            // Sort by temperature descending (hottest first)
            validPoints.sort((a, b) => b.temperature - a.temperature);
            
            // Find the two temperatures to interpolate between
            let upperPoint = null;
            let lowerPoint = null;
            
            for (let i = 0; i < validPoints.length - 1; i++) {
                if (validPoints[i].temperature >= temperature && validPoints[i + 1].temperature <= temperature) {
                    upperPoint = validPoints[i];
                    lowerPoint = validPoints[i + 1];
                    break;
                }
            }
            
            // If temperature is outside available range, use nearest
            if (!upperPoint || !lowerPoint) {
                if (temperature >= validPoints[0].temperature) {
                    return validPoints[0].height;
                } else if (temperature <= validPoints[validPoints.length - 1].temperature) {
                    return validPoints[validPoints.length - 1].height;
                }
                // Use the two closest available points
                upperPoint = validPoints[0];
                lowerPoint = validPoints[validPoints.length - 1];
            }
            
            // Interpolate between temperatures
            const tempRange = upperPoint.temperature - lowerPoint.temperature;
            if (tempRange === 0) return upperPoint.height;
            
            const tempRatio = (temperature - lowerPoint.temperature) / tempRange;
            return lowerPoint.height + tempRatio * (upperPoint.height - lowerPoint.height);
        }
        
        // Find height (altitude) for a given weight on a temperature curve
        function findHeightForWeight(tempData, weight) {
            const points = tempData.points;
            
            // Check if weight is in range
            const minWeight = points[0].x;
            const maxWeight = points[points.length - 1].x;
            
            if (weight < minWeight || weight > maxWeight) {
                return null;
            }
            
            // Find the two points that bracket this weight
            for (let i = 0; i < points.length - 1; i++) {
                if (points[i].x <= weight && points[i + 1].x >= weight) {
                    // Interpolate between these two points
                    const weightRatio = (weight - points[i].x) / (points[i + 1].x - points[i].x);
                    return points[i].y + weightRatio * (points[i + 1].y - points[i].y);
                }
            }
            
            return null;
        }
        
        function draw5ftIGEChart(ctx, canvas, qat, hp, acweight, maxWeight, maxAlt) {
            // Chart boundaries for 5ft_ige.png (595x822)
            const chartLeft = 54;
            const chartRight = 559;
            const chartTop = 29;
            const chartBottom = 600;
            
            const weightMin = 14000;
            const weightMax = 22000;
            const altMin = 0;
            const altMax = 20000;
            
            // Convert weight to X pixel
            function weightToX(w) {
                return chartLeft + ((w - weightMin) / (weightMax - weightMin)) * (chartRight - chartLeft);
            }
            
            // Convert altitude to Y pixel
            function altToY(a) {
                return chartBottom - ((a - altMin) / (altMax - altMin)) * (chartBottom - chartTop);
            }
            
            // Helper function to draw arrow
            function drawArrow(fromX, fromY, toX, toY, color) {
                const headLength = 10;
                const angle = Math.atan2(toY - fromY, toX - fromX);
                
                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.lineWidth = 2;
                
                // Draw arrow head
                ctx.beginPath();
                ctx.moveTo(toX, toY);
                ctx.lineTo(toX - headLength * Math.cos(angle - Math.PI / 6), toY - headLength * Math.sin(angle - Math.PI / 6));
                ctx.lineTo(toX - headLength * Math.cos(angle + Math.PI / 6), toY - headLength * Math.sin(angle + Math.PI / 6));
                ctx.closePath();
                ctx.fill();
            }
            
            // Disable image smoothing for crisp lines
            ctx.imageSmoothingEnabled = false;
            
            // Draw weight calculation in BLUE (horizontal from altitude, then down)
            if (maxWeight && maxWeight > weightMin && maxWeight < weightMax) {
                ctx.fillStyle = 'blue';
                
                const xWeight = Math.floor(weightToX(maxWeight));
                const yAlt = Math.floor(altToY(hp));
                const xLeft = Math.floor(chartLeft);
                
                // Draw horizontal line
                ctx.fillRect(xLeft, yAlt, xWeight - xLeft, 2);
                
                // Draw vertical line down
                ctx.fillRect(xWeight - 1, yAlt, 2, chartBottom + 80 - yAlt);
                
                // Draw point at intersection
                ctx.beginPath();
                ctx.arc(xWeight, yAlt, 5, 0, 2 * Math.PI);
                ctx.fill();
                
                // Draw arrow at end of horizontal line (pointing right)
                drawArrow(xLeft, yAlt + 1, xWeight - 5, yAlt + 1, 'blue');
                
                // Draw arrow at end of vertical line (pointing down)
                drawArrow(xWeight, yAlt, xWeight, chartBottom + 70, 'blue');
            }
            
            // Draw altitude calculation in RED (from weight up, then horizontal left)
            if (maxAlt && acweight > weightMin && acweight < weightMax) {
                ctx.fillStyle = 'red';
                
                const xAcWeight = Math.floor(weightToX(acweight));
                const yMaxAlt = Math.floor(altToY(maxAlt));
                const xLeft = Math.floor(chartLeft);
                
                // Draw vertical line from bottom up to intersection point
                ctx.fillRect(xAcWeight - 1, yMaxAlt, 2, chartBottom + 80 - yMaxAlt);
                
                // Draw horizontal line from intersection to left axis
                ctx.fillRect(xLeft, yMaxAlt, xAcWeight - xLeft, 2);
                
                // Draw point at intersection
                ctx.beginPath();
                ctx.arc(xAcWeight, yMaxAlt, 5, 0, 2 * Math.PI);
                ctx.fill();
                
                // Draw arrow at end of vertical line going up (pointing up)
                drawArrow(xAcWeight, chartBottom + 70, xAcWeight, yMaxAlt + 5, 'red');
                
                // Draw arrow at end of horizontal line (pointing left)
                drawArrow(xAcWeight, yMaxAlt + 1, xLeft + 5, yMaxAlt + 1, 'red');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Remove any existing toasts
            document.querySelectorAll('.toast').forEach(t => t.remove());
            
            // Re-override showToast after all scripts loaded
            window.showToast = function(message, type) {
                showChartError(message);
                // Also remove any toasts that might have been created
                document.querySelectorAll('.toast').forEach(t => t.remove());
            };
            
            setTimeout(function() {
                const savedData = JSON.parse(localStorage.getItem('allData') || '{}');
                
                if (savedData['ttl-weight']) {
                    document.getElementById('#acweight').value = savedData['ttl-weight'];
                }
                if (savedData['temperature']) {
                    document.getElementById('#qat').value = savedData['temperature'];
                }
                if (savedData['height']) {
                    document.getElementById('#hp').value = savedData['height'];
                }
                if (savedData['wind']) {
                    document.getElementById('#wind').value = savedData['wind'];
                }
            }, 100);
        });
    </script>
</body>
</html>
























































